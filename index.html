<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Webcam Face FX — Pipeline (from scratch)</title>
  <style>
    :root { --bg:#0f1115; --panel:#11141a; --stroke:#1f2430; --fg:#e5e7eb; --muted:#9aa0aa; --accent:#6ee7b7; --danger:#f87171; }
    html, body { height:100%; }
    body { margin:0; background:var(--bg); color:var(--fg); font:14px/1.55 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; display:grid; place-items:center; }
    .wrap { width:min(1280px,96vw); }
    .panel { background:var(--panel); border:1px solid var(--stroke); border-radius:16px; padding:14px; box-shadow:0 8px 30px rgba(0,0,0,.35); }
    header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px; }
    h1 { font-size:18px; margin:0; letter-spacing:.2px; }
    .controls { display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:10px; align-items:center; }
    .row { display:contents; }
    .col-span-2{ grid-column:span 2; } .col-span-3{ grid-column:span 3; } .col-span-4{ grid-column:span 4; } .col-span-6{ grid-column:span 6; } .col-span-12{ grid-column:span 12; }
    label { font-size:12px; color:var(--muted); display:flex; flex-direction:column; gap:6px; }
    input[type="range"], select, button, .badge { background:#0b0e13; color:var(--fg); border:1px solid var(--stroke); border-radius:10px; padding:8px 10px; }
    input[type="checkbox"]{ transform:translateY(1px); }
    .inline { display:flex; gap:10px; align-items:center; }
    button { cursor:pointer; }
    button:hover { border-color:#2e3748; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .badge { font-size:12px; }
    #stage { position:relative; aspect-ratio:16/9; background:#0c1016; border-radius:16px; overflow:hidden; margin-top:10px; }
    #glcanvas { display:block; width:100%; height:100%; }
    #video { display:none; }
    .note { color:var(--muted); margin-top:10px; font-size:12px; }
    .error { color:var(--danger); }
    footer { margin-top:10px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px; }
    a { color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    .gridline { height:1px; background:#1b1f2a; grid-column:1 / -1; margin:2px 0; }
    .sectionTitle { grid-column:1 / -1; font-weight:600; color:#cbd5e1; margin-top:4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <header>
        <h1>Webcam Face FX — Pipeline</h1>
        <div class="inline">
          <button id="startBtn">Start camera</button>
          <button id="stopBtn" disabled>Stop</button>
          <label class="badge inline"><input type="checkbox" id="mirrorChk" checked> Mirror</label>
          <label class="badge inline"><input type="checkbox" id="animateChk" checked> Animate</label>
          <label class="badge inline"><input type="checkbox" id="trackCenterChk" checked> Use face center</label>
          <label class="badge inline"><input type="checkbox" id="useMeshMaskChk"> Mask: FaceMesh</label>
          <span id="status" class="badge">Idle</span>
        </div>
      </header>

      <div class="layout">
        <aside class="sidebar" id="sidebar">
          <div class="sidebar-header">
            <strong>Controls</strong>
            <div class="inline" style="gap:6px">
              <button id="collapseBtn" title="Collapse sidebar">⟨⟨</button>
            </div>
          </div>
          <div class="controls" id="uiRoot">
            <div class="sectionTitle">Mask</div>
            <label class="col-span-3">Feather (px)
              <span class="inline"><input type="range" id="maskFeather" min="0" max="64" step="1" value="18"><span id="maskFeatherVal" class="badge">18</span></span>
            </label>
            <label class="col-span-3">Expand (px)
              <span class="inline"><input type="range" id="maskExpand" min="-40" max="120" step="1" value="16"><span id="maskExpandVal" class="badge">16</span></span>
            </label>
            <label class="col-span-3">Invert mask
              <span class="inline"><input type="checkbox" id="maskInvert"></span>
            </label>
            <label class="col-span-3">Fallback shape
              <select id="maskShape">
                <option value="0">Rounded Rect</option>
                <option value="1">Ellipse</option>
              </select>
            </label>

            <div class="row gridline"></div>
            <div class="sectionTitle">Pipeline</div>

            <!-- Stage 1: Distort -->
            <div class="sectionTitle">Stage A — Distort</div>
            <label class="col-span-3">Type
              <select id="s1Type">
                <option value="0">None</option>
                <option value="1">Wave (2D)</option>
                <option value="2">Noise Flow (Perlin)</option>
                <option value="3">Ripple (center)</option>
                <option value="4">Swirl (center)</option>
              </select>
            </label>
            <label class="col-span-3">Intensity <span class="inline"><input type="range" id="s1Int" min="0" max="1" step="0.01" value="0.9"><span id="s1IntVal" class="badge">0.90</span></span></label>
            <label class="col-span-3">Freq X <span class="inline"><input type="range" id="s1Fx" min="0" max="80" step="0.5" value="20"><span id="s1FxVal" class="badge">20.0</span></span></label>
            <label class="col-span-3">Freq Y <span class="inline"><input type="range" id="s1Fy" min="0" max="80" step="0.5" value="12"><span id="s1FyVal" class="badge">12.0</span></span></label>
            <label class="col-span-3">Amplitude (px) <span class="inline"><input type="range" id="s1Amp" min="0" max="80" step="1" value="18"><span id="s1AmpVal" class="badge">18</span></span></label>
            <label class="col-span-3">Noise scale <span class="inline"><input type="range" id="s1Scale" min="0.5" max="12" step="0.1" value="3"><span id="s1ScaleVal" class="badge">3.0</span></span></label>
            <label class="col-span-3">Noise strength (px) <span class="inline"><input type="range" id="s1Str" min="0" max="80" step="1" value="20"><span id="s1StrVal" class="badge">20</span></span></label>
            <label class="col-span-3">Swirl amount <span class="inline"><input type="range" id="s1Swirl" min="-6.28" max="6.28" step="0.01" value="2.0"><span id="s1SwirlVal" class="badge">2.00</span></span></label>
            <label class="col-span-3">Speed <span class="inline"><input type="range" id="s1Speed" min="0" max="5" step="0.01" value="1.0"><span id="s1SpeedVal" class="badge">1.00</span></span></label>
            <label class="col-span-3">Seed <span class="inline"><input type="range" id="s1Seed" min="0" max="100" step="1" value="7"><span id="s1SeedVal" class="badge">7</span></span></label>

            <div class="row gridline"></div>

            <!-- Stage 2: Smear/Blur-->
            <div class="sectionTitle">Stage B — Smear / Blur</div>
            <label class="col-span-3">Type
              <select id="s2Type">
                <option value="0">None</option>
                <option value="1">Directional Smear</option>
                <option value="2">Radial/Zoom Smear</option>
                <option value="3">Box Blur</option>
                <option value="4">Pixelate</option>
              </select>
            </label>
            <label class="col-span-3">Length (px) <span class="inline"><input type="range" id="s2Len" min="0" max="220" step="1" value="60"><span id="s2LenVal" class="badge">60</span></span></label>
            <label class="col-span-3">Angle (°) <span class="inline"><input type="range" id="s2Ang" min="0" max="360" step="1" value="0"><span id="s2AngVal" class="badge">0</span></span></label>
            <label class="col-span-3">Samples <span class="inline"><input type="range" id="s2Samples" min="1" max="48" step="1" value="24"><span id="s2SamplesVal" class="badge">24</span></span></label>
            <label class="col-span-3">Blur radius (px) <span class="inline"><input type="range" id="s2Blur" min="0" max="48" step="1" value="16"><span id="s2BlurVal" class="badge">16</span></span></label>
            <label class="col-span-3">Pixel size (px) <span class="inline"><input type="range" id="s2Pixel" min="1" max="64" step="1" value="16"><span id="s2PixelVal" class="badge">16</span></span></label>
            <label class="col-span-3">Intensity <span class="inline"><input type="range" id="s2Int" min="0" max="1" step="0.01" value="1"><span id="s2IntVal" class="badge">1.00</span></span></label>

            <div class="row gridline"></div>

            <!-- Stage 3: Glitch/Color -->
            <div class="sectionTitle">Stage C — Glitch / Color</div>
            <label class="col-span-3">Type
              <select id="s3Type">
                <option value="0">None</option>
                <option value="1">Glitch Rows</option>
                <option value="2">RGB Split</option>
                <option value="3">Posterize</option>
                <option value="4">Scanlines</option>
              </select>
            </label>
            <label class="col-span-3">Block (px) <span class="inline"><input type="range" id="s3Block" min="2" max="200" step="2" value="24"><span id="s3BlockVal" class="badge">24</span></span></label>
            <label class="col-span-3">Probability <span class="inline"><input type="range" id="s3Prob" min="0" max="1" step="0.01" value="0.45"><span id="s3ProbVal" class="badge">0.45</span></span></label>
            <label class="col-span-3">Shift X (px) <span class="inline"><input type="range" id="s3ShiftX" min="0" max="24" step="1" value="6"><span id="s3ShiftXVal" class="badge">6</span></span></label>
            <label class="col-span-3">Shift Y (px) <span class="inline"><input type="range" id="s3ShiftY" min="0" max="24" step="1" value="2"><span id="s3ShiftYVal" class="badge">2</span></span></label>
            <label class="col-span-3">Levels <span class="inline"><input type="range" id="s3Levels" min="2" max="32" step="1" value="6"><span id="s3LevelsVal" class="badge">6</span></span></label>
            <label class="col-span-3">Mix <span class="inline"><input type="range" id="s3Mix" min="0" max="1" step="0.01" value="1"><span id="s3MixVal" class="badge">1.00</span></span></label>

            <div class="row gridline"></div>

            <div class="sectionTitle">Feedback (datamosh-ish trail)</div>
            <label class="col-span-3 inline" style="gap:8px; margin-top:4px"><input type="checkbox" id="fbEnable"> Enable feedback</label>
            <label class="col-span-3">Decay <span class="inline"><input type="range" id="fbDecay" min="0" max="1" step="0.01" value="0.85"><span id="fbDecayVal" class="badge">0.85</span></span></label>
            <label class="col-span-3">Warp (px) <span class="inline"><input type="range" id="fbWarp" min="0" max="40" step="1" value="12"><span id="fbWarpVal" class="badge">12</span></span></label>
            <label class="col-span-3">Chroma (px) <span class="inline"><input type="range" id="fbChroma" min="0" max="16" step="1" value="4"><span id="fbChromaVal" class="badge">4</span></span></label>

            <div class="row gridline"></div>
            <div class="col-span-12 inline" style="justify-content:flex-end; gap:8px; position:sticky; bottom:0; background:linear-gradient(180deg, rgba(17,20,26,0) 0%, rgba(17,20,26,1) 20%); padding-top:8px; }">
              <button id="presetClean">Preset: Clean subtle</button>
              <button id="presetGlitch">Preset: Heavy glitch</button>
              <button id="presetSmear">Preset: Cinematic smear</button>
              <button id="randomBtn">Randomize</button>
            </div>
          </div>
          <div id="msg" class="note" style="margin-top:10px">This build uses a 3-stage GPU pipeline + optional feedback. The face mask can be FaceMesh or rect/ellipse fallback.</div>
          <footer class="sidebar-footer">
            <span>HTTPS • WebGL • FaceDetector / FaceMesh</span>
            <span id="status2" class="badge">—</span>
          </footer>
        </aside>

        <div class="resizer" id="resizer" title="Drag to resize"></div>

        <main class="main">
          <div id="stage">
            <video id="video" playsinline muted></video>
            <canvas id="glcanvas" aria-label="camera with face effects"></canvas>
          </div>
        </main>
      </div>
    </div>
  </div>

<script>
// --- Layout / sidebar resize ---
(() => {
  const root = document.documentElement;
  const sidebar = document.getElementById('sidebar');
  const resizer = document.getElementById('resizer');
  const collapseBtn = document.getElementById('collapseBtn');
  const LS_KEY = 'facefx.sidebar.w';
  let sidebarW = parseInt(localStorage.getItem(LS_KEY) || '380', 10);
  function applyW(){ sidebar.style.width = sidebarW + 'px'; }
  applyW();
  let dragging = false;
  resizer.addEventListener('mousedown', (e)=>{ dragging=true; document.body.classList.add('resizing'); e.preventDefault(); });
  window.addEventListener('mousemove', (e)=>{ if(!dragging) return; sidebarW = Math.max(260, Math.min(560, e.clientX - sidebar.getBoundingClientRect().left + sidebarW - sidebar.offsetWidth)); applyW(); localStorage.setItem(LS_KEY, sidebarW); window.dispatchEvent(new Event('resize')); });
  window.addEventListener('mouseup', ()=>{ if(dragging){ dragging=false; document.body.classList.remove('resizing'); } });
  collapseBtn.addEventListener('click', ()=>{ if(sidebar.offsetWidth>40){ sidebarW = 0; sidebar.style.width = '0px'; } else { sidebarW = parseInt(localStorage.getItem(LS_KEY) || '380',10); applyW(); } window.dispatchEvent(new Event('resize')); });
})();
</script>

<script>

</html>
