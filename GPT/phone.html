<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Get Recording — Unknown Remote</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b0d11; color:#e5e7eb; }
    .wrap { max-width: 560px; margin: 0 auto; padding: 24px; }
    .card { background:#11141a; border:1px solid #1f2430; border-radius:16px; padding:20px; }
    form { margin: 12px 0; display: flex; flex-direction: column; gap: 12px; }
    input[type="email"] {
        padding: 12px 14px;
        background: #0b0d11;
        border: 1px solid #333946;
        border-radius: 10px;
        color: #e5e7eb;
        font-size: 16px;
    }
    button {
        padding: 14px 16px;
        font-weight: 700;
        border: none;
        border-radius: 12px;
        background: #34d399;
        color: #0b0d11;
        font-size: 16px;
        cursor: pointer;
    }
    button:disabled { opacity:0.5; cursor: not-allowed; }
    .muted { color:#9aa0aa; font-size:14px; }
    .row { display:flex; gap:12px; align-items:center; }
    .ok { color:#34d399; } .bad { color:#f87171; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Unknown Remote</h1>
    <div class="card" id="card">
      <p class="muted">Enter your email to receive a 5-second capture from the installation.</p>
      <form id="emailForm">
          <input type="email" id="emailInput" placeholder="your.email@example.com" required>
          <button id="submitBtn" type="submit" disabled>Send Me The Clip</button>
      </form>
      <div class="row"><span>Connection:</span> <span id="connState" class="muted">connecting…</span></div>
      <div class="row" style="margin-top: 8px"><span>Status:</span> <span id="status" class="muted">—</span></div>
    </div>
  </div>

  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script>
  (function(){
    function qs(k){ return new URLSearchParams(location.search).get(k); }
    const hostId = qs('host'); const token = qs('token');
    const els = {
      form: document.getElementById('emailForm'),
      input: document.getElementById('emailInput'),
      btn: document.getElementById('submitBtn'),
      conn: document.getElementById('connState'),
      status: document.getElementById('status'),
    };

    if (!hostId || !token) {
      els.status.textContent = 'Missing host or token from URL.';
      els.status.className = 'bad';
      return;
    }

    function setConn(txt, ok=false){ els.conn.textContent = txt; els.conn.className = ok ? 'ok' : 'muted'; }
    function setStatus(txt, ok=true){ els.status.textContent = txt; els.status.className = ok ? 'ok' : 'bad'; }

    const peer = new Peer(undefined, { debug: 1 });
    let conn = null;

    peer.on('open', (id) => {
      conn = peer.connect(hostId, { reliable: true });
      conn.on('open', () => {
        setConn('connected', true);
        conn.send(JSON.stringify({ type:'hello', token }));
      });

      conn.on('data', (msg) => {
        if (typeof msg === 'string') {
          try {
            const data = JSON.parse(msg);
            if (data.type === 'helloAck') {
                setStatus('Ready to send request.');
                els.btn.disabled = false;
            } else if (data.type === 'recordingStarted') {
                setStatus('Host is recording your clip...');
            } else if (data.type === 'sendSuccess') {
                setStatus('Success! Check your email in a few minutes.', true);
                els.input.value = ''; // Clear input on success
                setTimeout(() => { els.btn.disabled = false; setStatus('Ready for another request.'); }, 8000);
            } else if (data.type === 'error') {
                setStatus(data.message || 'An unknown error occurred.', false);
                els.btn.disabled = false;
            }
          } catch(e) {
            console.error("Error parsing message:", e);
          }
        }
      });

      conn.on('close', () => { setConn('disconnected'); setStatus('Connection lost.', false); els.btn.disabled = true; });
      conn.on('error', (err) => { setConn('error'); setStatus('Connection error.', false); els.btn.disabled = true; console.error(err); });
    });

    els.form.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!conn || !conn.open) {
        setStatus('Not connected to host.', false);
        return;
      }
      const email = els.input.value;
      if (!email) {
        setStatus('Please enter an email address.', false);
        return;
      }

      els.btn.disabled = true;
      setStatus('Sending request to host…');
      conn.send(JSON.stringify({ type: 'requestRecording', email: email }));
    });

  })();
  </script>
</body>
</html>
