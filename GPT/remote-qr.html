<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UNKNOWN // QR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    body { background:#0b0d11; color:#e5e7eb; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace}
    canvas{ image-rendering: pixelated; }
  </style>
</head>
<body class="min-h-screen">
  <div class="max-w-xl mx-auto p-6 text-center space-y-4">
    <h1 class="text-xl font-bold">Scan to Participate</h1>
    <!-- Version string bumped in the HTML body -->
    <p class="text-xs text-gray-400 mono">UNKNOWN_V5.4_BODY</p>

    <div class="flex justify-center">
      <canvas id="qr"></canvas>
    </div>
    <div class="text-sm">
      <p class="text-gray-300">Point your camera at the QR to open the controller on your phone.</p>
      <p class="text-xs text-gray-500 mono mt-2"><span class="text-gray-400">URL:</span> <span id="u">—</span></p>
      <p class="text-xs text-gray-500 mono"><span class="text-gray-400">peer:</span> <span id="p">—</span> · <span class="text-gray-400">token:</span> <span id="t">—</span></p>
    </div>
  </div>

  <script>
    // Accept either a full "url" param, or host/token(/phone) to build it.
    const sp = new URLSearchParams(location.search);
    const host = sp.get('host');
    const token = sp.get('token');
    const phone = sp.get('phone') || 'phone.html';
    let url = sp.get('url');

    if (!url) {
      if (!host || !token) {
        document.getElementById('u').textContent = 'missing parameters';
        throw new Error('missing host/token');
      }
      const base = location.origin + location.pathname.replace(/[^/]+$/, '');
      const u = new URL(base + phone);
      u.searchParams.set('host', host);
      u.searchParams.set('token', token);
      url = u.toString();
    }

    document.getElementById('u').textContent = url;
    if (host) document.getElementById('p').textContent = host;
    if (token) document.getElementById('t').textContent = token;

    const canvas = document.getElementById('qr');
    QRCode.toCanvas(canvas, url, { width: 420, margin: 2 }, (err) => {
      if (err) console.error(err);
    });

    // Optional: blink the token text gently so staff notice it updates
    let on = true;
    setInterval(() => {
      on = !on;
      document.getElementById('t').style.opacity = on ? '1' : '.6';
    }, 1200);
  </script>
</body>
</html>
