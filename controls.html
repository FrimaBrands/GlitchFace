<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>U N K N O W N // Controls</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'JetBrains Mono', monospace; background-color: #0a0a0a; color: #EAEAEA; }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #111; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #444; }
    input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 2px; background: #333; outline: none; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 14px; height: 14px; background: #EAEAEA; cursor: pointer; border: none; border-radius: 0; }
    input[type="range"]::-moz-range-thumb { width: 14px; height: 14px; background: #EAEAEA; cursor: pointer; border: none; border-radius: 0; }
    .status-indicator::after { content: 'â– '; display: inline-block; margin-left: 6px; animation: blink 0.7s step-end infinite; color: #00ff00; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
    .status-indicator.error::after { color: #ff0000; }
    .tab-button { border-color: #333; transition: all 0.2s ease-in-out; }
    .tab-button.active { border-color: #EAEAEA; color: #FFFFFF; background-color: #1a1a1a; }
    .btn { border: 1px solid #555; transition: all 0.2s ease-in-out; }
    .btn:hover { background-color: #EAEAEA; color: #000; border-color: #EAEAEA; }
    .btn:disabled { opacity: 0.4; pointer-events: none; }
    .btn-primary { background-color: #EAEAEA; color: #000; border-color: #EAEAEA; }
    .btn-primary:hover { background-color: #000; color: #EAEAEA; }
    .form-checkbox { appearance: none; -webkit-appearance: none; height: 14px; width: 14px; background-color: transparent; border: 1px solid #555; cursor: pointer; }
    .form-checkbox:checked { background-color: #EAEAEA; }
  </style>
</head>
<body class="h-screen flex flex-col">
  <div class="controls-panel w-full h-full flex flex-col bg-[#0a0a0a]">
    <div class="p-4 border-b border-gray-800 flex-shrink-0">
      <h1 class="text-xl font-bold text-white tracking-widest">U N K N O W N</h1>
      <p class="text-sm text-gray-400 font-mono">// CONTROLS</p>
      <div id="msg" class="text-red-400 font-mono text-xs mt-2 h-4"></div>
      <div id="statusBar" class="font-mono text-xs status-indicator mt-2">STATUS: READY</div>
    </div>

    <div class="p-4 border-b border-gray-800 flex-shrink-0">
      <h2 class="font-bold text-gray-300 mb-2">// PRESET_MANAGER</h2>
      <select id="presetList" class="w-full bg-black border border-gray-700 p-2 mb-2 text-sm"></select>
      <div class="grid grid-cols-3 gap-2">
        <input type="text" id="presetName" placeholder="> Preset Name..." class="col-span-3 bg-black border border-gray-700 p-2 text-sm">
        <button id="savePresetBtn" class="btn font-semibold py-1 text-sm">Save</button>
        <button id="deletePresetBtn" class="btn font-semibold py-1 text-sm">Delete</button>
        <button id="randomBtn" class="btn font-semibold py-1 text-sm">Randomize</button>
      </div>
    </div>

    <div class="flex border-b border-gray-800 flex-shrink-0">
      <button id="globalsTabBtn" class="tab-button active flex-1 py-2 text-sm font-semibold">Globals</button>
      <button id="effectsTabBtn" class="tab-button flex-1 py-2 text-sm font-semibold">Effects</button>
    </div>

    <div class="flex-grow custom-scrollbar overflow-y-auto">
      <div id="effects-tab-content" class="hidden p-4 space-y-4"></div>
      <div id="globals-tab-content" class="p-4 space-y-4">
        <div class="control-group bg-black/50 border border-gray-800 p-3">
          <h3 class="font-semibold text-gray-200 mb-3">// REMOTE_TRIGGER</h3>
          <div class="space-y-3">
            <div class="grid grid-cols-2 gap-2">
              <button id="remoteShowQR" class="btn font-semibold py-2 text-sm">Open QR</button>
              <button id="remoteReset" class="btn font-semibold py-2 text-sm" disabled>Disarm</button>
            </div>
            <div id="remoteStatus" class="text-xs font-mono text-green-400">REMOTE: idle</div>
          </div>
        </div>

        <div class="control-group bg-black/50 border border-gray-800 p-3">
          <h3 class="font-semibold text-gray-200 mb-3">// BACKGROUND_SOURCE</h3>
          <div class="space-y-3">
            <button id="bgUploadBtn" class="w-full btn font-semibold py-2 text-sm">Upload Image/Video</button>
            <input type="file" id="bgUpload" accept="image/*,video/*" class="hidden">
            <label class="flex items-center justify-between text-sm cursor-pointer"><span>USE CUSTOM BG</span><input type="checkbox" id="useBgChk" class="form-checkbox" disabled></label>
            <div class="space-y-2">
              <div class="flex justify-between items-center"><label class="text-sm">MASK FEATHER</label><span id="maskFeatherValue" class="text-sm font-mono">0.150</span></div>
              <input type="range" id="maskFeather" min="0.01" max="0.5" step="0.001" value="0.15">
            </div>
          </div>
        </div>

        <div class="control-group bg-black/50 border border-gray-800 p-3">
          <h3 class="font-semibold text-gray-200 mb-3">// SYSTEM_SETTINGS</h3>
          <div class="space-y-3">
            <label class="flex items-center justify-between text-sm cursor-pointer"><span>ANIMATE EFFECTS</span><input type="checkbox" id="animateChk" class="form-checkbox" checked></label>
            <label class="flex items-center justify-between text-sm cursor-pointer"><span>MIRROR PREVIEW</span><input type="checkbox" id="mirrorChk" class="form-checkbox" checked></label>
            <label class="flex items-center justify-between text-sm cursor-pointer"><span>SHOW LOGOS</span><input type="checkbox" id="logoChk" class="form-checkbox" checked></label>
          </div>
        </div>

        <div class="control-group bg-black/50 border border-gray-800 p-3">
          <h3 class="font-semibold text-gray-200 mb-3">// AUTOMATION_MODULE</h3>
          <div class="space-y-2">
            <div class="flex justify-between items-center"><label class="text-sm">AUTO-RANDOMIZE</label><span id="autoRandomizeValue" class="text-sm font-mono">1.0s</span></div>
            <input type="range" id="autoRandomizeSlider" min="0" max="30" step="0.5" value="1">
          </div>
          <div class="space-y-2 mt-3">
            <div class="flex justify-between items-center"><label class="text-sm">PRESET-ITERATION</label><span id="presetIterationValue" class="text-sm font-mono">Off</span></div>
            <input type="range" id="presetIterationSlider" min="0" max="30" step="0.5" value="0">
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  // --- CONTROLS logic ---
  (() => {
    const UI = {
      elements: {}, state: { ui: {}, jitter: {} }, globalState: { ui: {} },
      definitions: {}, globalDefinitions: {},
      init(definitions, globalDefinitions) {
        this.definitions = definitions; this.globalDefinitions = globalDefinitions;
        const ids = ['statusBar','msg','savePresetBtn','deletePresetBtn','presetName','presetList','randomBtn','animateChk','mirrorChk','logoChk','bgUploadBtn','bgUpload','useBgChk','maskFeather','maskFeatherValue','effectsTabBtn','globalsTabBtn','effects-tab-content','globals-tab-content','autoRandomizeSlider','autoRandomizeValue','presetIterationSlider','presetIterationValue'];
        ids.forEach(id => this.elements[id] = document.getElementById(id));
        for (const [k,def] of Object.entries(this.definitions)) this.createControlGroup(k,def,this.state,this.elements['effects-tab-content'],true);
        for (const [k,def] of Object.entries(this.globalDefinitions)) this.createControlGroup(k,def,this.globalState,this.elements['globals-tab-content'],false);
        this.elements.effectsTabBtn.addEventListener('click', () => this.switchTab('effects'));
        this.elements.globalsTabBtn.addEventListener('click', () => this.switchTab('globals'));
        this.elements.bgUploadBtn.addEventListener('click', () => this.elements.bgUpload.click());
        this.elements.maskFeather.addEventListener('input', () => { this.elements.maskFeatherValue.textContent = parseFloat(this.elements.maskFeather.value).toFixed(3); });
        this.elements.autoRandomizeSlider.addEventListener('input', () => { const v = parseFloat(this.elements.autoRandomizeSlider.value); this.elements.autoRandomizeValue.textContent = v===0?'Off':`${v.toFixed(1)}s`; });
        this.elements.presetIterationSlider.addEventListener('input', () => { const v = parseFloat(this.elements.presetIterationSlider.value); this.elements.presetIterationValue.textContent = v===0?'Off':`${v.toFixed(1)}s`; });
        document.querySelectorAll('input, select').forEach(el => el.addEventListener('change', () => App.broadcastState()));
        document.querySelectorAll('input[type="range"]').forEach(el => el.addEventListener('input', () => App.broadcastState()));
      },
      switchTab(tab){ const eff=tab==='effects'; this.elements.effectsTabBtn.classList.toggle('active',eff); this.elements.globalsTabBtn.classList.toggle('active',!eff); this.elements['effects-tab-content'].classList.toggle('hidden',!eff); this.elements['globals-tab-content'].classList.toggle('hidden',eff); },
      createControlGroup(key, def, stateObj, parent, withToggle){
        const group=document.createElement('div'); group.className='control-group bg-black/50 border border-gray-800 p-3';
        const header=document.createElement('div'); header.className='flex items-center justify-between';
        const title=document.createElement('h3'); title.className='font-semibold text-gray-200'; title.textContent=`// ${def.title.toUpperCase()}`; header.appendChild(title);
        const content=document.createElement('div'); content.className='mt-3 space-y-3';
        if(withToggle){ header.classList.add('cursor-pointer'); const toggle=document.createElement('input'); toggle.type='checkbox'; toggle.checked=def.active; toggle.className='form-checkbox';
          if(!def.active) content.classList.add('hidden');
          toggle.addEventListener('change',()=>{ def.active=toggle.checked; App.broadcastState(); });
          header.addEventListener('click',(e)=>{ if(e.target!==toggle){ toggle.checked=!toggle.checked; toggle.dispatchEvent(new Event('change')); } content.classList.toggle('hidden',!toggle.checked); });
          def.toggleElement=toggle; header.appendChild(toggle);
        }
        stateObj.ui[key]={}; if(stateObj.jitter){ stateObj.jitter[key]={}; }
        for(const [controlKey,controlDef] of Object.entries(def.controls)){
          const slider=this.createSlider(controlKey,controlDef); content.appendChild(slider.container);
          stateObj.ui[key][controlKey]=slider.input;
          if(stateObj.jitter){ stateObj.jitter[key][controlKey]={ base: controlDef.value, current: controlDef.value }; slider.input.addEventListener('input',()=>{ stateObj.jitter[key][controlKey].base=parseFloat(slider.input.value); }); }
        }
        group.append(header,content); parent.appendChild(group);
      },
      createSlider(id,def){ const c=document.createElement('div'); c.className='space-y-2';
        const lc=document.createElement('div'); lc.className='flex justify-between items-center';
        const label=document.createElement('label'); label.className='text-sm'; label.textContent=def.label.toUpperCase();
        const val=document.createElement('span'); val.className='text-sm font-mono';
        const input=document.createElement('input'); input.type='range'; Object.assign(input,{min:def.min,max:def.max,step:def.step,value:def.value});
        const upd=()=>val.textContent=parseFloat(input.value).toFixed(String(def.step).includes('.')?3:0);
        input.addEventListener('input',upd); upd(); lc.append(label,val); c.append(lc,input); return {container:c,input};
      },
      updateJitter(t){
        if(!this.definitions.Jitter.active) return;
        const { j
