<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Remote Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peer.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0a0a;
            color: #e5e7eb;
            -webkit-tap-highlight-color: transparent;
        }
        .font-mono {
            font-family: 'JetBrains Mono', monospace;
        }
        .btn-record {
            transition: all 0.2s ease-in-out;
        }
        .btn-record:active {
            transform: scale(0.95);
            background-color: #10b981;
        }
        .btn-record:disabled {
            background-color: #4b5563;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-sm text-center">
        <div id="main-content" class="bg-gray-900/50 border border-gray-800 rounded-lg p-8 space-y-6">
            <h1 class="text-2xl font-bold text-white">REMOTE RECORDER</h1>
            
            <div class="bg-black/50 border border-gray-700 rounded p-4">
                <p class="text-sm font-mono text-gray-400">STATUS</p>
                <p id="status" class="text-lg font-semibold text-green-400 mt-1">Initializing...</p>
            </div>

            <button id="recordBtn" class="w-full bg-green-500 text-black font-bold py-4 px-4 rounded-lg text-xl btn-record shadow-lg shadow-green-500/20" disabled>
                START RECORDING
            </button>

            <div id="download-container" class="hidden pt-4">
                <a id="downloadLink" class="w-full block bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition-colors">
                    Download Recording
                </a>
                <p class="text-xs text-gray-500 mt-2">Click above to save the 5-second video.</p>
            </div>
        </div>
    </div>

    <script>
        const recordBtn = document.getElementById('recordBtn');
        const statusEl = document.getElementById('status');
        const downloadContainer = document.getElementById('download-container');
        const downloadLink = document.getElementById('downloadLink');

        let peer = null;
        let conn = null;
        let currentBlobUrl = null;

        function setStatus(text, isError = false) {
            statusEl.textContent = text;
            statusEl.classList.toggle('text-red-400', isError);
            statusEl.classList.toggle('text-green-400', !isError);
        }

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const hostId = urlParams.get('host');

            if (!hostId) {
                setStatus('Error: Host ID missing from URL.', true);
                return;
            }

            try {
                peer = new Peer();
            } catch(err) {
                console.error("PeerJS init failed:", err);
                setStatus('Connection Failed', true);
                return;
            }


            peer.on('open', id => {
                setStatus('Connecting to host...');
                conn = peer.connect(hostId, { reliable: true });

                conn.on('open', () => {
                    setStatus('Connected. Ready to record.', false);
                    recordBtn.disabled = false;
                });

                conn.on('data', (data) => {
                    if (data.type === 'status') {
                        setStatus(data.message, false);
                    } else if (data.type === 'video-blob') {
                        setStatus('File received!', false);
                        recordBtn.disabled = false;
                        recordBtn.textContent = 'RECORD AGAIN';

                        // Clean up old blob URL if it exists
                        if (currentBlobUrl) {
                            URL.revokeObjectURL(currentBlobUrl);
                        }
                        
                        currentBlobUrl = URL.createObjectURL(data.blob);
                        downloadLink.href = currentBlobUrl;
                        downloadLink.download = `recording_${Date.now()}.webm`;
                        downloadContainer.classList.remove('hidden');
                    }
                });
                
                conn.on('close', () => {
                    setStatus('Host disconnected.', true);
                    recordBtn.disabled = true;
                });
            });

            peer.on('error', (err) => {
                console.error('PeerJS error:', err);
                setStatus(`Error: ${err.type}`, true);
                recordBtn.disabled = true;
            });
        };

        recordBtn.addEventListener('click', () => {
            if (conn && conn.open) {
                conn.send({ type: 'start-recording' });
                setStatus('Request sent...', false);
                recordBtn.disabled = true;
                downloadContainer.classList.add('hidden');
            } else {
                setStatus('Not connected to host.', true);
            }
        });
    </script>
</body>
</html>
